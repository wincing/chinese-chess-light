{"version":3,"sources":["assets\\scripts\\Piece.js"],"names":["cc","Class","Component","setflag","status","X","Y","fixGrid","x","y","grid","node","grids","size","getContentSize","rect","Rect","height","width","contains","Vec2","flag","hasPiece","lastX","lastY","gx","gy","piece","isInRange","onTouchStart","event","disable","getComponents","manger","enlighten","onTouchMove","delta","touch","getDelta","onTouchEnd","self","putDownMusic","loader","loadRes","AudioClip","err","clip","audioEngine","play","i","j","range","startX","startY","undefined","updateAll","checkPass","passedAction","onLoad","on","Node","EventType","TOUCH_START","TOUCH_MOVE","TOUCH_END","onDestroy","off","start","type","parent","getComponent","len"],"mappings":"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","sourceRoot":"/","sourcesContent":["/**\r\n * 负责棋子的事件与交互的类\r\n * \r\n * @property {cc.Node} node 该脚本挂载的节点\r\n * \r\n * @property {Number} node.lastX 上一次棋子的x坐标\r\n * \r\n * @property {Number} node.lastY 上一次棋子的x坐标\r\n * \r\n * @property {Number} node.startX 棋子的初始x坐标\r\n * \r\n * @property {Number} node.startY 棋子的初始y坐标\r\n * \r\n * @property {Number} node.gx 棋子所处在格子的二维数组的行下标\r\n * \r\n * @property {Number} node.gy 棋子所处在格子的二维数组的列下标\r\n * \r\n * @property {Grid[]} node.grids 所有格子的引用数组\r\n * \r\n * @property {PieceManager} node.manger 对所有棋子进行管理\r\n * \r\n * @property {cc.Rect} node.range 棋盘所围成矩形\r\n * \r\n * @property {Boolean} node.isInRange 标识棋子是否位于棋盘\r\n * \r\n * @property {Boolean} node.disable 标识棋子是否失效 \r\n * \r\n * @property {Boolean} node.type 标识棋子种类， 红棋为0， 黑棋为1\r\n */\r\ncc.Class({\r\n    extends: cc.Component,\r\n \r\n    /**\r\n     * 标记棋子对周围格子的影响，将在子类中实现\r\n     * @param {Number} status 1表示棋子下放, -1表示离开\r\n     * @param {*} X 格子行下标\r\n     * @param {*} Y 格子列下标\r\n     */\r\n    setflag: function(status, X, Y) {},\r\n \r\n\r\n    /**\r\n     * 确定棋子是否属于当前格子, 若属于, 则更新棋子状态\r\n     * @param {*} x 格子行下标\r\n     * @param {*} y 格子列下标\r\n     * @returns 属于返回true, 不属于返回false\r\n     */\r\n    fixGrid: function(x, y) {\r\n        var grid = this.node.grids[x][y];\r\n\r\n        // 该格子所在的矩形\r\n        var size = grid.getContentSize();\r\n        var rect = new cc.Rect(grid.x, grid.y - size.height, size.width, size.height);\r\n\r\n        if(rect.contains(new cc.Vec2(this.node.x, this.node.y)) && grid.flag && !grid.hasPiece) {\r\n\r\n            this.node.x = this.node.lastX = grid.x + size.width / 2;\r\n            this.node.y = this.node.lastY = grid.y - size.height / 2;\r\n\r\n            this.node.gx = x;\r\n            this.node.gy = y;\r\n\r\n            grid.hasPiece = true; \r\n            grid.piece = this.node;\r\n\r\n            this.node.isInRange = true;\r\n            return true;                 \r\n        } \r\n\r\n        return false;\r\n    },\r\n\r\n    /**\r\n     * 棋子开始拖动触发, 消除该棋子影响\r\n     */\r\n    onTouchStart: function(event) {\r\n        if(this.isInRange) {\r\n            this.grids[this.gx][this.gy].hasPiece = false;\r\n\r\n            // 清除未失效棋子的影响\r\n            if(!this.disable) { \r\n                this.getComponents(cc.Component)[1].setflag(-1, this.gx, this.gy);\r\n            }\r\n            this.manger.enlighten();\r\n        }\r\n    },\r\n\r\n    /**\r\n     * 棋子拖动中, 持续更新棋子坐标\r\n     */\r\n    onTouchMove: function(event) {\r\n        var delta = event.touch.getDelta();\r\n        this.x += delta.x;\r\n        this.y += delta.y;\r\n    },\r\n    \r\n\r\n    /**\r\n     * 当棋子下放时, 触发下放音效, 判断棋子是否落于某个格子, 更新所有格子状态，判断是否通关\r\n     */\r\n    onTouchEnd: function(event) {\r\n\r\n        // 下放音效\r\n        var self = this;\r\n        if (!self.putDownMusic) {\r\n           cc.loader.loadRes(\"music/pieceDown\", cc.AudioClip, function (err, clip) {\r\n                self.putDownMusic = clip;\r\n                cc.audioEngine.play(clip, false, 0.5);// 音量\r\n           });\r\n        } else {\r\n           cc.audioEngine.play(self.putDownMusic, false, 1);\r\n        }\r\n\r\n        // 检查棋子是否被某个格子包含\r\n        for(var i = 0; i < 10; i++) {\r\n            for(var j = 0; j < 10; j++) {\r\n                if(this.getComponents(cc.Component)[1].fixGrid(i, j)) {                                 \r\n                    break;\r\n                } \r\n            }\r\n        }\r\n\r\n        // 棋子落点在棋盘外，回到起始点\r\n        if(!this.range.contains(new cc.Vec2(this.x, this.y))) {\r\n            this.x = this.lastX = this.startX;\r\n            this.y = this.lastY = this.startY;\r\n            this.gx = undefined;\r\n            this.isInRange = false;\r\n        } else {    //返回上一个位置\r\n            if(this.gx != undefined) {\r\n                this.grids[this.gx][this.gy].hasPiece = true;\r\n            }\r\n            this.x = this.lastX;\r\n            this.y = this.lastY;\r\n        }\r\n\r\n        // 更新所有格子状态并进行点亮\r\n        this.manger.updateAll();\r\n        this.manger.enlighten(); \r\n\r\n        // 判断是否通关\r\n        if(this.manger.checkPass()) {\r\n            this.manger.passedAction();\r\n        }\r\n    },\r\n\r\n    onLoad () {\r\n        this.node.on(cc.Node.EventType.TOUCH_START, this.onTouchStart, this.node); \r\n        this.node.on(cc.Node.EventType.TOUCH_MOVE, this.onTouchMove, this.node);\r\n        this.node.on(cc.Node.EventType.TOUCH_END, this.onTouchEnd, this.node); \r\n    },\r\n\r\n    onDestroy () {\r\n        this.node.off(cc.Node.EventType.TOUCH_START, this.onTouchStart, this.node);\r\n        this.node.off(cc.Node.EventType.TOUCH_MOVE, this.onTouchMove, this.node);\r\n        this.node.off(cc.Node.EventType.TOUCH_END, this.onTouchEnd, this.node); \r\n    },\r\n\r\n    /**\r\n     * 初始化\r\n     */\r\n    start () {\r\n\r\n        this.node.type = 0;\r\n\r\n        this.node.disable = false;\r\n\r\n        this.node.isInRange = false;\r\n\r\n        this.node.startX = this.node.lastX = this.node.x;\r\n        this.node.startY = this.node.lastY = this.node.y;\r\n\r\n        this.node.manger = this.node.parent.getComponent(\"PieceManager\");\r\n\r\n        // 棋盘所在矩形\r\n        var grid = this.node.grids[9][0];\r\n        var len = grid.getContentSize().width;\r\n        this.node.range = new cc.Rect(grid.x, grid.y - len, len * 10, len * 10);\r\n\r\n    },\r\n\r\n});\r\n"]}